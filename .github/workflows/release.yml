name: Release Build and Package

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Tag name for release"
        required: false
        default: ""

env:
  VCPKG_ROOT: ${{ github.workspace }}/vcpkg

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            vcpkg_triplet: x64-linux
            platform_name: linux-x64
            executable_name: YumeCard
          - os: windows-latest
            vcpkg_triplet: x64-mingw-static
            platform_name: windows-x64
            executable_name: YumeCard.exe

    runs-on: ${{ matrix.os }}

    env:
      VCPKG_DEFAULT_TRIPLET: ${{ matrix.vcpkg_triplet }}
      VCPKG_FEATURE_FLAGS: manifests,registries,versions

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version info
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ github.event.inputs.tag_name }}" ]; then
            echo "VERSION=${{ github.event.inputs.tag_name }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref_type }}" == "tag" ]; then
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=dev-$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT
          fi
        shell: bash

      - name: Cache vcpkg
        uses: actions/cache@v4
        with:
          path: ${{ env.VCPKG_ROOT }}
          key: release-vcpkg-${{ matrix.vcpkg_triplet }}-${{ hashFiles('vcpkg.json') }}
          restore-keys: |
            release-vcpkg-${{ matrix.vcpkg_triplet }}-
            vcpkg-${{ matrix.vcpkg_triplet }}-

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build curl ca-certificates git tar zip unzip pkg-config build-essential
        shell: bash

      - name: Install system dependencies (Windows)
        if: runner.os == 'Windows'
        run: |
          choco install ninja
        shell: pwsh

      - name: Setup vcpkg (Linux)
        if: runner.os == 'Linux'
        run: |
          if [ ! -d "${{ env.VCPKG_ROOT }}" ]; then
            git clone https://github.com/Microsoft/vcpkg.git ${{ env.VCPKG_ROOT }}
          fi
          ${{ env.VCPKG_ROOT }}/bootstrap-vcpkg.sh
        shell: bash

      - name: Setup vcpkg (Windows)
        if: runner.os == 'Windows'
        run: |
          if (!(Test-Path "${{ env.VCPKG_ROOT }}")) {
            git clone https://github.com/Microsoft/vcpkg.git ${{ env.VCPKG_ROOT }}
          }
          & "${{ env.VCPKG_ROOT }}\bootstrap-vcpkg.bat"
        shell: pwsh

      - name: Install vcpkg packages (Linux)
        if: runner.os == 'Linux'
        run: |
          cd ${{ github.workspace }}
          ${{ env.VCPKG_ROOT }}/vcpkg install --triplet ${{ env.VCPKG_DEFAULT_TRIPLET }}
        shell: bash
        env:
          VCPKG_FORCE_SYSTEM_BINARIES: 1

      - name: Install vcpkg packages (Windows)
        if: runner.os == 'Windows'
        run: |
          cd ${{ github.workspace }}
          & "${{ env.VCPKG_ROOT }}\vcpkg.exe" install --triplet ${{ env.VCPKG_DEFAULT_TRIPLET }}
        shell: pwsh

      - name: Configure CMake
        run: |
          cmake -B ${{ github.workspace }}/build -S ${{ github.workspace }} -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE=${{ env.VCPKG_ROOT }}/scripts/buildsystems/vcpkg.cmake -G "Ninja" -DVCPKG_TARGET_TRIPLET=${{ env.VCPKG_DEFAULT_TRIPLET }} -DVCPKG_LIBRARY_LINKAGE=static -DCMAKE_MSVC_RUNTIME_LIBRARY=MultiThreaded
        env:
          VCPKG_FORCE_SYSTEM_BINARIES: 1

      - name: Build
        run: cmake --build ${{ github.workspace }}/build --config Release

      - name: Verify build
        run: |
          if [ "${{ runner.os }}" == "Linux" ]; then
            if [ -f "${{ github.workspace }}/build/${{ matrix.executable_name }}" ]; then
              echo "âœ… Build successful: ${{ matrix.executable_name }}"
              file "${{ github.workspace }}/build/${{ matrix.executable_name }}"
              ldd "${{ github.workspace }}/build/${{ matrix.executable_name }}" || echo "Static executable - no dynamic dependencies"
            else
              echo "âŒ Build failed: ${{ matrix.executable_name }} not found"
              find "${{ github.workspace }}/build/" -type f -name "*" | head -10
              exit 1
            fi
          fi
        shell: bash

      - name: Verify build (Windows)
        if: runner.os == 'Windows'
        run: |
          if (Test-Path "${{ github.workspace }}\build\${{ matrix.executable_name }}") {
            Write-Host "âœ… Build successful: ${{ matrix.executable_name }}"
            Get-Item "${{ github.workspace }}\build\${{ matrix.executable_name }}"
          } else {
            Write-Host "âŒ Build failed: ${{ matrix.executable_name }} not found"
            Get-ChildItem "${{ github.workspace }}\build\" | Select-Object -First 10
            exit 1
          }
        shell: pwsh

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.platform_name }}-${{ steps.version.outputs.VERSION }}
          path: ${{ github.workspace }}/build/${{ matrix.executable_name }}
          retention-days: 1

  package:
    needs: build
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform_name: linux-x64
            executable_name: YumeCard
            archive_type: tar.gz
          - os: windows-latest
            platform_name: windows-x64
            executable_name: YumeCard.exe
            archive_type: zip

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from build job
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ github.event.inputs.tag_name }}" ]; then
            echo "VERSION=${{ github.event.inputs.tag_name }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref_type }}" == "tag" ]; then
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=dev-$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT
          fi
        shell: bash

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-${{ matrix.platform_name }}-${{ steps.get_version.outputs.VERSION }}
          path: build/

      - name: Make executable (Linux)
        if: runner.os == 'Linux'
        run: chmod +x build/${{ matrix.executable_name }}

      - name: Create package directory (Linux)
        if: runner.os == 'Linux'
        run: mkdir -p package/YumeCard-${{ steps.get_version.outputs.VERSION }}-${{ matrix.platform_name }}
        shell: bash

      - name: Create package directory (Windows)
        if: runner.os == 'Windows'
        run: New-Item -ItemType Directory -Force -Path "package\YumeCard-${{ steps.get_version.outputs.VERSION }}-${{ matrix.platform_name }}"
        shell: pwsh

      - name: Copy files to package (Linux)
        if: runner.os == 'Linux'
        run: |
          PACKAGE_DIR="package/YumeCard-${{ steps.get_version.outputs.VERSION }}-${{ matrix.platform_name }}"

          # Copy executable
          cp build/${{ matrix.executable_name }} "$PACKAGE_DIR/"

          # Copy project files
          [ -f "README.md" ] && cp README.md "$PACKAGE_DIR/" || echo "README.md not found"
          [ -f "LICENSE" ] && cp LICENSE "$PACKAGE_DIR/" || echo "LICENSE not found"
          [ -f "package.json" ] && cp package.json "$PACKAGE_DIR/" || echo "package.json not found"
          [ -f "package-lock.json" ] && cp package-lock.json "$PACKAGE_DIR/" || echo "package-lock.json not found"

          # Copy directories
          [ -d "Style" ] && cp -r Style "$PACKAGE_DIR/" || echo "Style directory not found"
          [ -d "config" ] && cp -r config "$PACKAGE_DIR/" || echo "config directory not found"

          # Create version file
          cat > "$PACKAGE_DIR/VERSION.txt" << 'VERSIONEOF'
          YumeCard ${{ steps.get_version.outputs.VERSION }} for Linux x64
          Build Date: $(date)
          Platform: Linux x64
          Static Linking: Yes
          Commit: ${{ github.sha }}
          VERSIONEOF

          # Create install guide
          cat > "$PACKAGE_DIR/INSTALL.txt" << 'INSTALLEOF'
          # YumeCard Installation Guide

          ## Requirements
          - No additional dependencies required (statically linked)
          - Node.js (for web-related features, if needed)

          ## Installation Steps
          1. Extract this archive to your desired location
          2. Make the executable file executable: chmod +x YumeCard
          3. Run: ./YumeCard

          ## Directory Structure
          - YumeCard: Main executable
          - Style/: UI styles and themes
          - config/: Configuration files
          - package.json: Node.js dependencies information
          - README.md: Project documentation
          - LICENSE: License information

          ## Troubleshooting
          - If you encounter permission issues, make sure the executable has proper permissions
          - For configuration, check the config/ directory
          INSTALLEOF
        shell: bash

      - name: Copy files to package (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $PACKAGE_DIR = "package\YumeCard-${{ steps.get_version.outputs.VERSION }}-${{ matrix.platform_name }}"

          # Copy executable
          Copy-Item "build\${{ matrix.executable_name }}" "$PACKAGE_DIR\"

          # Copy project files
          if (Test-Path "README.md") { Copy-Item "README.md" "$PACKAGE_DIR\" }
          if (Test-Path "LICENSE") { Copy-Item "LICENSE" "$PACKAGE_DIR\" }
          if (Test-Path "package.json") { Copy-Item "package.json" "$PACKAGE_DIR\" }
          if (Test-Path "package-lock.json") { Copy-Item "package-lock.json" "$PACKAGE_DIR\" }

          # Copy directories
          if (Test-Path "Style") { Copy-Item "Style" "$PACKAGE_DIR\" -Recurse }
          if (Test-Path "config") { Copy-Item "config" "$PACKAGE_DIR\" -Recurse }          # Create version file
          $version = "${{ steps.get_version.outputs.VERSION }}"
          $versionContent = "YumeCard $version for Windows x64`nBuild Date: $(Get-Date)`nPlatform: Windows x64`nStatic Linking: Yes`nCommit: ${{ github.sha }}"
          $versionContent | Out-File -FilePath "$PACKAGE_DIR\VERSION.txt" -Encoding UTF8

          # Create install guide
          $installContent = "# YumeCard Installation Guide`n`n## Requirements`n- No additional dependencies required (statically linked)`n- Node.js (for web-related features, if needed)`n`n## Installation Steps`n1. Extract this archive to your desired location`n2. Run: YumeCard.exe`n`n## Directory Structure`n- YumeCard.exe: Main executable`n- Style/: UI styles and themes`n- config/: Configuration files`n- package.json: Node.js dependencies information`n- README.md: Project documentation`n- LICENSE: License information`n`n## Troubleshooting`n- If Windows Defender blocks the executable, add it to exclusions`n- For configuration, check the config/ directory"
          $installContent | Out-File -FilePath "$PACKAGE_DIR\INSTALL.txt" -Encoding UTF8

      - name: Create archive (Linux)
        if: runner.os == 'Linux'
        run: |
          cd package
          tar -czf YumeCard-${{ steps.get_version.outputs.VERSION }}-${{ matrix.platform_name }}.tar.gz YumeCard-${{ steps.get_version.outputs.VERSION }}-${{ matrix.platform_name }}/
          echo "ASSET_PATH=$(pwd)/YumeCard-${{ steps.get_version.outputs.VERSION }}-${{ matrix.platform_name }}.tar.gz" >> $GITHUB_ENV
          echo "ASSET_NAME=YumeCard-${{ steps.get_version.outputs.VERSION }}-${{ matrix.platform_name }}.tar.gz" >> $GITHUB_ENV
        shell: bash

      - name: Create archive (Windows)
        if: runner.os == 'Windows'
        run: |
          cd package
          Compress-Archive -Path "YumeCard-${{ steps.get_version.outputs.VERSION }}-${{ matrix.platform_name }}" -DestinationPath "YumeCard-${{ steps.get_version.outputs.VERSION }}-${{ matrix.platform_name }}.zip"
          $currentPath = Get-Location
          echo "ASSET_PATH=$currentPath\YumeCard-${{ steps.get_version.outputs.VERSION }}-${{ matrix.platform_name }}.zip" >> $env:GITHUB_ENV
          echo "ASSET_NAME=YumeCard-${{ steps.get_version.outputs.VERSION }}-${{ matrix.platform_name }}.zip" >> $env:GITHUB_ENV
        shell: pwsh

      - name: Upload package artifacts
        uses: actions/upload-artifact@v4
        with:
          name: YumeCard-${{ steps.get_version.outputs.VERSION }}-${{ matrix.platform_name }}
          path: ${{ env.ASSET_PATH }}
          retention-days: 30

  release:
    # æ­¤ä½œä¸šåˆ›å»º GitHub Releaseã€‚
    # é‡è¦æç¤ºï¼šæ­¤å·¥ä½œæµçš„ 'on' è§¦å‘å™¨å½“å‰ä»…ä¸º 'workflow_dispatch'ã€‚
    # æ­¤ 'if' æ¡ä»¶ç¡®ä¿ä»…å½“é€šè¿‡ dispatch æä¾› tag_name æ—¶æ‰è¿è¡Œ release ä½œä¸šã€‚
    # å¦‚æœæ‚¨æ‰“ç®—åœ¨æ¨é€æ ‡ç­¾æˆ– GitHub å‘å¸ƒäº‹ä»¶æ—¶è§¦å‘å‘å¸ƒï¼Œ
    # åˆ™éœ€è¦æ›´æ–°æ–‡ä»¶é¡¶éƒ¨çš„ 'on' å—å’Œæ­¤ 'if' æ¡ä»¶ã€‚
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.tag_name != ''
    needs: [package] # ä¾èµ–äº package ä½œä¸šå‡†å¤‡å¥½å·¥ä»¶ã€‚
    runs-on: ubuntu-latest

    steps:
      - name: å‡†å¤‡å‘å¸ƒä¿¡æ¯
        id: release_info
        run: |
          echo "VERSION=${{ github.event.inputs.tag_name }}" >> $GITHUB_OUTPUT
          echo "RELEASE_DATE=$(date --utc --iso-8601=seconds)" >> $GITHUB_OUTPUT
        shell: bash

      - name: ä¸‹è½½æ‰€æœ‰å·²æ‰“åŒ…çš„å·¥ä»¶
        uses: actions/download-artifact@v4
        with:
          path: artifacts/ # 'package' ä½œä¸šä¸­çš„æ‰€æœ‰å·¥ä»¶éƒ½å°†ä¸‹è½½åˆ°æ­¤å¤„ã€‚

      - name: æ˜¾ç¤ºå·²ä¸‹è½½å·¥ä»¶çš„ç»“æ„
        run: |
          echo "Structure of downloaded artifacts in ./artifacts/:"
          ls -R artifacts
          echo "Archives found:"
          find artifacts/ -type f \( -name "*.tar.gz" -o -name "*.zip" \)
        shell: bash

      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.release_info.outputs.VERSION }}
          name: YumeCard ${{ steps.release_info.outputs.VERSION }}
          body: |
            ## YumeCard ${{ steps.release_info.outputs.VERSION }}

            å‘å¸ƒäº: ${{ steps.release_info.outputs.RELEASE_DATE }}
            æäº¤: ${{ github.sha }} <!-- å·¥ä½œæµè§¦å‘æäº¤çš„ SHA -->

            ### ğŸ“¦ ä¸‹è½½
            - **Linux x64**: `YumeCard-${{ steps.release_info.outputs.VERSION }}-linux-x64.tar.gz`
            - **Windows x64**: `YumeCard-${{ steps.release_info.outputs.VERSION }}-windows-x64.zip`

            ### ğŸ”§ æ„å»ºä¿¡æ¯
            - é™æ€é“¾æ¥: Yes
            - C++ æ ‡å‡†: C++26 
            <!-- æ³¨æ„: ä» head_commit.timestamp è·å–çš„ 'Build Date' å·²ç§»é™¤ï¼Œå› ä¸ºå®ƒå¯¹äº workflow_dispatch ä¸å¯é ã€‚
                 å‘å¸ƒæ—¥æœŸç°åœ¨ä½äºé¡¶éƒ¨ã€‚ -->

            ### ğŸ“ åŒ…å†…å®¹
            - ä¸»å¯æ‰§è¡Œæ–‡ä»¶ (YumeCard/YumeCard.exe)
            - Style ç›®å½• (UI ä¸»é¢˜å’Œæ ·å¼)
            - config ç›®å½• (é…ç½®æ–‡ä»¶)
            - Node.js æ–‡ä»¶ (package.json, package-lock.json)
            - æ–‡æ¡£ (README.md, LICENSE, INSTALL.txt, VERSION.txt)

            ### ğŸ“‹ å®‰è£…
            1. ä¸‹è½½é€‚ç”¨äºæ‚¨å¹³å°çš„ç›¸åº”åŒ…
            2. å°†å­˜æ¡£è§£å‹ç¼©åˆ°æ‚¨æœŸæœ›çš„ä½ç½®
            3. æŒ‰ç…§ INSTALL.txt ä¸­çš„è¯´æ˜è¿›è¡Œæ“ä½œ
            4. è¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶

            ### âš ï¸ è¦æ±‚
            - æ— éœ€å…¶ä»–ä¾èµ–é¡¹ (é™æ€é“¾æ¥)
            - å»ºè®®ä½¿ç”¨ Node.js ä»¥æ”¯æŒä¸ Web ç›¸å…³çš„åŠŸèƒ½

            ### ğŸ†• æ–°å¢å†…å®¹
            æŸ¥çœ‹ä¸æ ‡ç­¾ ${{ steps.release_info.outputs.VERSION }} ç›¸å…³çš„æäº¤å†å²ä»¥è·å–è¯¦ç»†æ›´æ”¹ã€‚
          draft: false
          prerelease: ${{ contains(steps.release_info.outputs.VERSION, 'beta') || contains(steps.release_info.outputs.VERSION, 'alpha') || contains(steps.release_info.outputs.VERSION, 'rc') }}
          files: artifacts/**/*
