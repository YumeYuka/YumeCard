name: Release Build and Deploy

on:
  push:
    tags:
      - "v*.*.*" # åŒ¹é…ç‰ˆæœ¬æ ‡ç­¾å¦‚ v1.0.0
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: "Release version (e.g., v1.0.0)"
        required: true
        default: "v1.0.0"
      prerelease:
        description: "Mark as pre-release"
        required: false
        default: false
        type: boolean

env:
  VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite"

jobs:
  # å¤šå¹³å°ç¼–è¯‘æž„å»º
  build-matrix:
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windowsæž„å»º
          - name: "windows-x64"
            display_name: "Windows x64"
            os: windows-latest
            arch: x64
            platform: x64
            vcpkg_triplet: x64-windows
            cmake_generator: "Visual Studio 17 2022"
            executable_name: "YumeCard_x64.exe"
            package_format: "zip"

          - name: "windows-x86"
            display_name: "Windows x86"
            os: windows-latest
            arch: x86
            platform: Win32
            vcpkg_triplet: x86-windows
            cmake_generator: "Visual Studio 17 2022"
            executable_name: "YumeCard_x86.exe"
            package_format: "zip"

          - name: "windows-arm64"
            display_name: "Windows ARM64"
            os: windows-latest
            arch: arm64
            platform: ARM64
            vcpkg_triplet: arm64-windows
            cmake_generator: "Visual Studio 17 2022"
            executable_name: "YumeCard_arm64.exe"
            package_format: "zip"

          # Linuxæž„å»º
          - name: "linux-x64"
            display_name: "Linux x64"
            os: ubuntu-latest
            arch: x64
            platform: x64
            vcpkg_triplet: x64-linux
            cmake_generator: "Unix Makefiles"
            executable_name: "YumeCard_x64"
            package_format: "tar.gz"

          - name: "linux-arm64"
            display_name: "Linux ARM64"
            os: ubuntu-latest
            arch: arm64
            platform: arm64
            vcpkg_triplet: arm64-linux
            cmake_generator: "Unix Makefiles"
            executable_name: "YumeCard_arm64"
            package_format: "tar.gz"
            cross_compile: true

          # macOSæž„å»º
          - name: "macos-x64"
            display_name: "macOS Intel"
            os: macos-latest
            arch: x64
            platform: x64
            vcpkg_triplet: x64-osx
            cmake_generator: "Unix Makefiles"
            executable_name: "YumeCard_x64"
            package_format: "tar.gz"

          - name: "macos-arm64"
            display_name: "macOS Apple Silicon"
            os: macos-latest
            arch: arm64
            platform: arm64
            vcpkg_triplet: arm64-osx
            cmake_generator: "Unix Makefiles"
            executable_name: "YumeCard_arm64"
            package_format: "tar.gz"

          - name: "macos-universal"
            display_name: "macOS Universal"
            os: macos-latest
            arch: universal
            platform: universal
            vcpkg_triplet: x64-osx
            cmake_generator: "Unix Makefiles"
            executable_name: "YumeCard_universal"
            package_format: "tar.gz"
            universal_binary: true

    runs-on: ${{ matrix.os }}
    name: Build ${{ matrix.display_name }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11

      - name: Get version from tag or input
        id: get_version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/}
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "version_no_v=${VERSION#v}" >> $GITHUB_OUTPUT

      # Linuxäº¤å‰ç¼–è¯‘å·¥å…·å®‰è£…
      - name: Install Linux cross-compilation tools
        if: matrix.cross_compile && matrix.arch == 'arm64'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

      # å®‰è£…é¡¹ç›®ä¾èµ–
      - name: Install dependencies
        shell: bash
        run: |
          if [ "${{ matrix.cross_compile }}" = "true" ] && [ "${{ matrix.arch }}" = "arm64" ]; then
            export CC=aarch64-linux-gnu-gcc
            export CXX=aarch64-linux-gnu-g++
          fi

          # å®‰è£…æ ¸å¿ƒä¾èµ–
          vcpkg install curl nlohmann-json zlib --triplet ${{ matrix.vcpkg_triplet }}

          # Windowsç‰¹å®šä¾èµ–
          if [ "${{ runner.os }}" = "Windows" ]; then
            vcpkg install openssl --triplet ${{ matrix.vcpkg_triplet }}
          fi

      # Windows CMakeé…ç½®
      - name: Configure CMake (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          cmake -B build `
            -A ${{ matrix.platform }} `
            -G "${{ matrix.cmake_generator }}" `
            -DCMAKE_BUILD_TYPE=Release `
            -DVCPKG_TARGET_TRIPLET=${{ matrix.vcpkg_triplet }} `
            -DCMAKE_TOOLCHAIN_FILE="${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake" `
            -DYUMECARD_VERSION="${{ steps.get_version.outputs.version_no_v }}"

      # Linux/macOS CMakeé…ç½®
      - name: Configure CMake (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          CMAKE_ARGS=(
            -B build
            -G "${{ matrix.cmake_generator }}"
            -DCMAKE_BUILD_TYPE=Release
            -DVCPKG_TARGET_TRIPLET=${{ matrix.vcpkg_triplet }}
            -DCMAKE_TOOLCHAIN_FILE=${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake
            -DYUMECARD_VERSION="${{ steps.get_version.outputs.version_no_v }}"
          )

          # macOSæž¶æž„è®¾ç½®
          if [ "${{ runner.os }}" = "macOS" ]; then
            if [ "${{ matrix.universal_binary }}" = "true" ]; then
              CMAKE_ARGS+=(-DCMAKE_OSX_ARCHITECTURES="x86_64;arm64")
            elif [ "${{ matrix.arch }}" = "arm64" ]; then
              CMAKE_ARGS+=(-DCMAKE_OSX_ARCHITECTURES=arm64)
            elif [ "${{ matrix.arch }}" = "x64" ]; then
              CMAKE_ARGS+=(-DCMAKE_OSX_ARCHITECTURES=x86_64)
            fi
            CMAKE_ARGS+=(-DCMAKE_OSX_DEPLOYMENT_TARGET=10.15)
          fi

          # Linuxäº¤å‰ç¼–è¯‘è®¾ç½®
          if [ "${{ matrix.cross_compile }}" = "true" ] && [ "${{ matrix.arch }}" = "arm64" ]; then
            CMAKE_ARGS+=(
              -DCMAKE_C_COMPILER=aarch64-linux-gnu-gcc
              -DCMAKE_CXX_COMPILER=aarch64-linux-gnu-g++
              -DCMAKE_SYSTEM_NAME=Linux
              -DCMAKE_SYSTEM_PROCESSOR=aarch64
            )
          fi

          cmake "${CMAKE_ARGS[@]}"

      # ç¼–è¯‘æž„å»º
      - name: Build project
        run: |
          cmake --build build --config Release --parallel $(nproc 2>/dev/null || sysctl -n hw.ncpu 2>/dev/null || echo 4)
        shell: bash

      # è¿è¡ŒåŸºæœ¬æµ‹è¯•
      - name: Run tests
        shell: bash
        run: |
          cd build/bin
          if [ -f "${{ matrix.executable_name }}" ]; then
            echo "Testing executable: ${{ matrix.executable_name }}"
            ./${{ matrix.executable_name }} --version || echo "Version check completed"
            ./${{ matrix.executable_name }} --help || echo "Help command completed"
            echo "Basic tests passed"
          else
            echo "Executable not found: ${{ matrix.executable_name }}"
            ls -la
            exit 1
          fi

      # åˆ›å»ºå‘å¸ƒåŒ…
      - name: Create release package
        shell: bash
        run: |
          cd build

          # åˆ›å»ºå‘å¸ƒç›®å½•
          PACKAGE_NAME="YumeCard-${{ steps.get_version.outputs.version }}-${{ matrix.name }}"
          mkdir -p release/$PACKAGE_NAME

          # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
          cp bin/${{ matrix.executable_name }} release/$PACKAGE_NAME/

          # å¤åˆ¶èµ„æºæ–‡ä»¶
          if [ -d "../out" ]; then
            cp -r ../out/* release/$PACKAGE_NAME/ 2>/dev/null || true
          fi

          # å¤åˆ¶æ–‡æ¡£
          cp ../README.md release/$PACKAGE_NAME/ 2>/dev/null || true
          cp ../BUILD.md release/$PACKAGE_NAME/ 2>/dev/null || true
          cp ../MULTI_ARCH_README.md release/$PACKAGE_NAME/ 2>/dev/null || true

          # åˆ›å»ºå®‰è£…è„šæœ¬
          if [ "${{ runner.os }}" != "Windows" ]; then
            cat > release/$PACKAGE_NAME/install.sh << EOF
          #!/bin/bash
          echo "Installing YumeCard..."
          sudo mkdir -p /usr/local/bin
          sudo cp ${{ matrix.executable_name }} /usr/local/bin/yumecard
          sudo chmod +x /usr/local/bin/yumecard
          echo "YumeCard installed to /usr/local/bin/yumecard"
          echo "Run 'yumecard --help' to get started"
          EOF
            chmod +x release/$PACKAGE_NAME/install.sh
          else
            cat > release/$PACKAGE_NAME/install.bat << EOF
          @echo off
          echo Installing YumeCard...
          if not exist "%ProgramFiles%\\YumeCard" mkdir "%ProgramFiles%\\YumeCard"
          copy "${{ matrix.executable_name }}" "%ProgramFiles%\\YumeCard\\"
          echo YumeCard installed to %ProgramFiles%\\YumeCard
          echo Add %ProgramFiles%\\YumeCard to your PATH to use 'yumecard' command
          pause
          EOF
          fi

          # åˆ›å»ºåŒ…
          cd release
          if [ "${{ matrix.package_format }}" = "zip" ]; then
            zip -r ${PACKAGE_NAME}.zip $PACKAGE_NAME
          else
            tar -czf ${PACKAGE_NAME}.tar.gz $PACKAGE_NAME
          fi

          # ç”Ÿæˆæ ¡éªŒå’Œ
          if command -v sha256sum >/dev/null; then
            sha256sum ${PACKAGE_NAME}.* > ${PACKAGE_NAME}.sha256
          elif command -v shasum >/dev/null; then
            shasum -a 256 ${PACKAGE_NAME}.* > ${PACKAGE_NAME}.sha256
          fi

      # ä¸Šä¼ æž„å»ºäº§ç‰©
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}-build
          path: build/release/*

  # åˆ›å»ºGitHub Release
  create-release:
    needs: build-matrix
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from tag or input
        id: get_version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/}
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "version_no_v=${VERSION#v}" >> $GITHUB_OUTPUT

      # ä¸‹è½½æ‰€æœ‰æž„å»ºäº§ç‰©
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts

      # ç”Ÿæˆå‘å¸ƒè¯´æ˜Ž
      - name: Generate release notes
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          ## YumeCard ${{ steps.get_version.outputs.version }}

          ### æ–°ç‰ˆæœ¬ç‰¹æ€§
          - å¤šå¹³å°æ”¯æŒï¼šWindows (x64, x86, ARM64), Linux (x64, ARM64), macOS (Intel, Apple Silicon, Universal)
          - ä¼˜åŒ–çš„æž„å»ºç³»ç»Ÿå’Œæ€§èƒ½æ”¹è¿›
          - å®Œæ•´çš„CI/CDè‡ªåŠ¨åŒ–æµç¨‹

          ### ä¸‹è½½è¯´æ˜Ž
          é€‰æ‹©é€‚åˆæ‚¨ç³»ç»Ÿçš„ç‰ˆæœ¬ï¼š

          #### Windows
          - **YumeCard-${{ steps.get_version.outputs.version }}-windows-x64.zip** - Windows 64ä½ (æŽ¨è)
          - **YumeCard-${{ steps.get_version.outputs.version }}-windows-x86.zip** - Windows 32ä½
          - **YumeCard-${{ steps.get_version.outputs.version }}-windows-arm64.zip** - Windows ARM64

          #### Linux
          - **YumeCard-${{ steps.get_version.outputs.version }}-linux-x64.tar.gz** - Linux 64ä½ (æŽ¨è)
          - **YumeCard-${{ steps.get_version.outputs.version }}-linux-arm64.tar.gz** - Linux ARM64

          #### macOS
          - **YumeCard-${{ steps.get_version.outputs.version }}-macos-universal.tar.gz** - macOS é€šç”¨ç‰ˆæœ¬ (æŽ¨è)
          - **YumeCard-${{ steps.get_version.outputs.version }}-macos-x64.tar.gz** - macOS Intel
          - **YumeCard-${{ steps.get_version.outputs.version }}-macos-arm64.tar.gz** - macOS Apple Silicon

          ### å®‰è£…è¯´æ˜Ž
          1. ä¸‹è½½é€‚åˆæ‚¨ç³»ç»Ÿçš„åŽ‹ç¼©åŒ…
          2. è§£åŽ‹åˆ°æ‚¨é€‰æ‹©çš„ç›®å½•
          3. è¿è¡ŒåŒ…å«çš„å®‰è£…è„šæœ¬ï¼ˆå¯é€‰ï¼‰
          4. ä½¿ç”¨ `yumecard --help` æŸ¥çœ‹ä½¿ç”¨è¯´æ˜Ž

          ### æ ¡éªŒå’Œ (SHA256)
          æ¯ä¸ªä¸‹è½½åŒ…éƒ½åŒ…å«ç›¸åº”çš„ `.sha256` æ–‡ä»¶ç”¨äºŽæ ¡éªŒæ–‡ä»¶å®Œæ•´æ€§ã€‚

          ### ç³»ç»Ÿè¦æ±‚
          - Windows: Windows 10/11 æˆ–æ›´é«˜ç‰ˆæœ¬
          - Linux: çŽ°ä»£Linuxå‘è¡Œç‰ˆ (Ubuntu 18.04+, CentOS 7+, ç­‰)
          - macOS: macOS 10.15 (Catalina) æˆ–æ›´é«˜ç‰ˆæœ¬

          EOF

      # åˆ›å»ºRelease
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.version }}
          name: YumeCard ${{ steps.get_version.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ github.event.inputs.prerelease == 'true' }}
          files: |
            release-artifacts/**/*.zip
            release-artifacts/**/*.tar.gz
            release-artifacts/**/*.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # è¾“å‡ºå‘å¸ƒä¿¡æ¯
      - name: Release Summary
        run: |
          echo "ðŸŽ‰ YumeCard ${{ steps.get_version.outputs.version }} å‘å¸ƒæˆåŠŸ!"
          echo ""
          echo "ðŸ“¦ æž„å»ºçš„å¹³å°:"
          echo "  - Windows: x64, x86, ARM64"
          echo "  - Linux: x64, ARM64"
          echo "  - macOS: Intel, Apple Silicon, Universal"
          echo ""
          echo "ðŸ”— å‘å¸ƒé“¾æŽ¥: https://github.com/${{ github.repository }}/releases/tag/${{ steps.get_version.outputs.version }}"
